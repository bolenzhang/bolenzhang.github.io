
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>以太坊源码解读 | Bolen`s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Bolen Zhang">
    

    
    <meta name="description" content="go-ethereum源码解析1、以太坊概述1.1 简介1.2 以太坊架构以太坊总体架构：  上图简要描述了以太的软件架构，可以看出是EVM和智能合约扩展了上层应用程序，使之成为区块链2.0. 区块链六层架构：   数据层：是一个区块 + 链表的数据结构，本质是一个分布式区块链 网络层：p2p网络。 共识层：制定区块链的获取货币的机制。比如比特币用的是POW(Proof of Work工作量证明机">
<meta name="keywords" content="以太坊源码解读">
<meta property="og:type" content="article">
<meta property="og:title" content="以太坊源码解读">
<meta property="og:url" content="http://yoursite.com/2018/05/29/以太坊源码解读【1】/index.html">
<meta property="og:site_name" content="Bolen`s Blog">
<meta property="og:description" content="go-ethereum源码解析1、以太坊概述1.1 简介1.2 以太坊架构以太坊总体架构：  上图简要描述了以太的软件架构，可以看出是EVM和智能合约扩展了上层应用程序，使之成为区块链2.0. 区块链六层架构：   数据层：是一个区块 + 链表的数据结构，本质是一个分布式区块链 网络层：p2p网络。 共识层：制定区块链的获取货币的机制。比如比特币用的是POW(Proof of Work工作量证明机">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://p8azvgsnq.bkt.clouddn.com/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%9E%B6%E6%9E%84.jpg">
<meta property="og:image" content="http://p8azvgsnq.bkt.clouddn.com/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E5%85%AD%E5%B1%82%E7%BB%93%E6%9E%84.jpg">
<meta property="og:image" content="http://p8azvgsnq.bkt.clouddn.com/eth_repo.png">
<meta property="og:image" content="http://p8azvgsnq.bkt.clouddn.com/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%8A%B6%E6%80%81%E6%A0%91.png">
<meta property="og:image" content="http://p8azvgsnq.bkt.clouddn.com/trie%20tree.png">
<meta property="og:image" content="http://p8azvgsnq.bkt.clouddn.com/Patricia%20tree%E7%A4%BA%E6%84%8F%E5%9B%BE.png">
<meta property="og:image" content="http://p8azvgsnq.bkt.clouddn.com/%E5%8F%B6%E5%AD%90%E8%8A%82%E7%82%B9.png">
<meta property="og:image" content="http://p8azvgsnq.bkt.clouddn.com/%E6%89%A9%E5%B1%95%E8%8A%82%E7%82%B9.png">
<meta property="og:image" content="http://p8azvgsnq.bkt.clouddn.com/%E5%88%86%E6%94%AF%E8%8A%82%E7%82%B9.png">
<meta property="og:image" content="http://p8azvgsnq.bkt.clouddn.com/%E9%BB%98%E5%85%8B%E5%B0%94-%E5%B8%95%E7%89%B9%E9%87%8C%E5%A4%8F%E6%A0%91.png">
<meta property="og:image" content="http://p8azvgsnq.bkt.clouddn.com/%E5%A5%87%E5%81%B6%E6%80%A7%E5%89%8D%E7%BC%80.png">
<meta property="og:image" content="http://p8azvgsnq.bkt.clouddn.com/%E9%BB%98%E5%85%8B%E5%B0%94-%E5%B8%95%E7%89%B9%E9%87%8C%E5%A4%8F%E6%A0%912.png">
<meta property="og:updated_time" content="2018-06-01T14:30:19.795Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="以太坊源码解读">
<meta name="twitter:description" content="go-ethereum源码解析1、以太坊概述1.1 简介1.2 以太坊架构以太坊总体架构：  上图简要描述了以太的软件架构，可以看出是EVM和智能合约扩展了上层应用程序，使之成为区块链2.0. 区块链六层架构：   数据层：是一个区块 + 链表的数据结构，本质是一个分布式区块链 网络层：p2p网络。 共识层：制定区块链的获取货币的机制。比如比特币用的是POW(Proof of Work工作量证明机">
<meta name="twitter:image" content="http://p8azvgsnq.bkt.clouddn.com/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%9E%B6%E6%9E%84.jpg">

    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Bolen`s Blog" title="Bolen`s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Bolen`s Blog">Bolen`s Blog</a></h1>
				<h2 class="blog-motto">Summarize &amp; share</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
						<li><a href="/index">标签</a></li>
					
						<li><a href="/categories">分类</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:yoursite.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2018/05/29/以太坊源码解读【1】/" title="以太坊源码解读" itemprop="url">以太坊源码解读</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Bolen Zhang" target="_blank" itemprop="author">Bolen Zhang</a>
		
  <p class="article-time">
    <time datetime="2018-05-29T12:56:33.000Z" itemprop="datePublished"> Published 2018-05-29</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		
		<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#go-ethereum源码解析"><span class="toc-text">go-ethereum源码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、以太坊概述"><span class="toc-text">1、以太坊概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-简介"><span class="toc-text">1.1 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-以太坊架构"><span class="toc-text">1.2 以太坊架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-以太坊常用项目介绍"><span class="toc-text">1.3 以太坊常用项目介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-以太坊目录简介"><span class="toc-text">1.4 以太坊目录简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-以太坊关键概念"><span class="toc-text">1.5 以太坊关键概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-3-交易"><span class="toc-text">1.5.3 交易</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-4-收据"><span class="toc-text">1.5.4 收据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-5-RLP编码"><span class="toc-text">1.5.5 RLP编码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-6-默克尔-帕特里夏树"><span class="toc-text">1.5.6 默克尔-帕特里夏树</span></a></li></ol></li></ol></li></ol></li></ol>
		
		</div>
		
		<h1 id="go-ethereum源码解析"><a href="#go-ethereum源码解析" class="headerlink" title="go-ethereum源码解析"></a><code>go-ethereum</code>源码解析</h1><h2 id="1、以太坊概述"><a href="#1、以太坊概述" class="headerlink" title="1、以太坊概述"></a>1、以太坊概述</h2><h3 id="1-1-简介"><a href="#1-1-简介" class="headerlink" title="1.1 简介"></a>1.1 简介</h3><h3 id="1-2-以太坊架构"><a href="#1-2-以太坊架构" class="headerlink" title="1.2 以太坊架构"></a>1.2 以太坊架构</h3><p><strong>以太坊总体架构：</strong></p>
<p><img src="http://p8azvgsnq.bkt.clouddn.com/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%9E%B6%E6%9E%84.jpg" alt="以太坊总体架构"></p>
<p>上图简要描述了以太的软件架构，可以看出是EVM和智能合约扩展了上层应用程序，使之成为区块链2.0.</p>
<p><strong>区块链六层架构：</strong></p>
<p><img src="http://p8azvgsnq.bkt.clouddn.com/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E5%85%AD%E5%B1%82%E7%BB%93%E6%9E%84.jpg" alt="区块链结构"></p>
<ul>
<li>数据层：是一个区块 + 链表的数据结构，本质是一个分布式区块链</li>
<li>网络层：p2p网络。</li>
<li>共识层：制定区块链的获取货币的机制。比如比特币用的是POW(Proof of Work工作量证明机制)：电脑的性能越好，越容易获取到货币奖励。还有POS(Proof of Stake权益证明机制)：类似于众筹分红的概念，会根据你持有的货币数量和时间，给持有者发放利息。还有比如超级账本用的是PBFT（拜赞庭容错）。</li>
<li>激励层：挖矿机制</li>
<li>合约层：以往的区块链是没有这一层的。所以最初的区块链只能进行交易，而无法用于其他的领域或是进行其他的逻辑处理。但是合约层的出现，使得在其他领域使用区块链成为了现实，比如用于IOT。以太坊中这部分包括了EVM(以太坊虚拟机)和智能合约两部分。</li>
</ul>
<ul>
<li>应用层：区块链的展示层。如以太坊使用的是truffle和web3-js.区块链的应用层可以是移动端，web端，或是是融合进现有的服务器，把当前的业务服务器当成应用层。</li>
</ul>
<h3 id="1-3-以太坊常用项目介绍"><a href="#1-3-以太坊常用项目介绍" class="headerlink" title="1.3 以太坊常用项目介绍"></a>1.3 以太坊常用项目介绍</h3><p>以太坊的源码托管在<a href="https://github.com/ethereum" target="_blank" rel="noopener">https://github.com/ethereum</a></p>
<p><img src="http://p8azvgsnq.bkt.clouddn.com/eth_repo.png" alt="eth_repo"></p>
<p>由上图可以看到以太坊有两种语言写的客户端，其中<code>go-ethereum</code>是官方首推的版本，<code>cpp</code>是用c++写的版本，两个版本功能完全一样，只是不同语言实现的而已。</p>
<p>除了以上的核心客户端外，以太坊还提供了一系列独立的工具，例如还在实验中的智能合约编程语言Viper、Solidity，和以太坊的JS调用库Web3.js，以太坊官方钱包等。目前eth的<code>github</code>官网已经有150多个各类功能的工具项目，以下整理一些常用的进行说明：</p>
<ol>
<li><code>go-ethereum</code></li>
</ol>
<p>官方go语言客户端，客户端文件是<code>geth</code>。这是使用最广泛的客户端，类似比特币的中本聪客户端，可用于挖矿、组建私有链，管理帐号、部署智能合约等。但是不能编译只能合约（1.6之前还是内置编译模块的，1.6之后就独立出去了）。该客户端可以作为一个独立程序运行，也可以作为一个库文件嵌入其他的GO、Android和ios项目中，它没有界面，是一个命令行程序。</p>
<ol start="2">
<li>cpp-ethereum</li>
</ol>
<p>与第一个相同，只是用C++实现的。</p>
<ol start="3">
<li>EIPs</li>
</ol>
<p>官方描述是eth平台的实施标准，包括核心协议详述，客户端API及合约的标准。</p>
<p>以上三项也是官方github置顶的三个项目。</p>
<ol start="4">
<li>mist</li>
</ol>
<p>JS写的一个DAPP browser客户端，可以用于浏览和使用DAPP，类似app strore，此前也是钱包客户端，其实可以把<code>Ethereum Wallet</code>理解为配置Mist Browser上的一个<code>dapp</code>。</p>
<p>MIST一般是配合<code>go-ethereum</code>或者<code>cpp-ethereum</code>运行的，如果在Mist启动是没有运行一个命令行的<code>ethereum</code>客户端，则mist将启动区块链数据同步（通常绑定<code>geth</code>客户端）。如果想要Mist运行在一个私有网络，只要在Mist启动前先启动节点（即<code>geth</code>）即可，Mist可以通过IPC链接到私有链。</p>
<ol start="5">
<li>Solidity项目。</li>
</ol>
<p>Solidity使用C++开发，客户端文件为solc，跨平台，使用命令行界面。solc是一个基本的编译平台，Solidity是以太坊智能合约的编程语言。</p>
<ol start="6">
<li>browse-solidity项目</li>
</ol>
<p>智能合约浏览器版本的IDE，可以直接在浏览器中进行开发、调试、编译。</p>
<ol start="7">
<li>Remix</li>
</ol>
<p>智能合约（以太坊称为DAPP）开发IDE，采用图形化界面可以支持DAPP的编写、调试、部署，是目前最主流的以太坊智能合约开发平台。Remix现在可以和brower Solidity集成在一起使用了。</p>
<ol start="8">
<li>pyethereum项目</li>
</ol>
<p>Python语言编写的以太坊客户端。</p>
<ol start="9">
<li>ethereumj项目</li>
</ol>
<p>Java语言编写的客户端，与geth功能完全相同。</p>
<h3 id="1-4-以太坊目录简介"><a href="#1-4-以太坊目录简介" class="headerlink" title="1.4 以太坊目录简介"></a>1.4 以太坊目录简介</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">accounts        	 实现了一个高等级的以太坊账户管理</span><br><span class="line">bmt					二进制的默克尔树的实现</span><br><span class="line">build				主要是编译和构建的一些脚本和配置</span><br><span class="line">cmd			命令行工具，又分了很多的命令行工具，下面一个一个介绍</span><br><span class="line">	/abigen		Source code generator to convert Ethereum contract definitions into easy to use, compile-time type-safe Go packages</span><br><span class="line">	/bootnode	启动一个仅仅实现网络发现的节点</span><br><span class="line">	/evm		以太坊虚拟机的开发工具， 用来提供一个可配置的，受隔离的代码调试环境</span><br><span class="line">	/faucet		</span><br><span class="line">	/geth		以太坊命令行客户端，最重要的一个工具</span><br><span class="line">	/p2psim		提供了一个工具来模拟http的API</span><br><span class="line">	/puppeth	创建一个新的以太坊网络的向导</span><br><span class="line">	/rlpdump 	提供了一个RLP数据的格式化输出</span><br><span class="line">	/swarm		swarm网络的接入点</span><br><span class="line">	/util		提供了一些公共的工具</span><br><span class="line">	/wnode		这是一个简单的Whisper节点。 它可以用作独立的引导节点。此外，可以用于不同的测试和诊断目的。</span><br><span class="line">common			提供了一些公共的工具类</span><br><span class="line">compression		Package rle implements the run-length encoding used for Ethereum data.</span><br><span class="line">consensus		提供了以太坊的一些共识算法，比如ethhash, clique(proof-of-authority)</span><br><span class="line">console			console类</span><br><span class="line">contracts	</span><br><span class="line">core			以太坊的核心数据结构和算法(虚拟机，状态，区块链，布隆过滤器)</span><br><span class="line">crypto			加密和hash算法，</span><br><span class="line">eth				实现了以太坊的协议</span><br><span class="line">ethclient		提供了以太坊的RPC客户端</span><br><span class="line">ethdb			eth的数据库(包括实际使用的leveldb和供测试使用的内存数据库)</span><br><span class="line">ethstats		提供网络状态的报告</span><br><span class="line">event			处理实时的事件</span><br><span class="line">les				实现了以太坊的轻量级协议子集</span><br><span class="line">light			实现为以太坊轻量级客户端提供按需检索的功能</span><br><span class="line">log				提供对人机都友好的日志信息</span><br><span class="line">metrics			提供磁盘计数器</span><br><span class="line">miner			提供以太坊的区块创建和挖矿</span><br><span class="line">mobile			移动端使用的一些warpper</span><br><span class="line">node			以太坊的多种类型的节点</span><br><span class="line">p2p				以太坊p2p网络协议</span><br><span class="line">rlp				以太坊序列化处理</span><br><span class="line">rpc				远程方法调用</span><br><span class="line">swarm			swarm网络处理</span><br><span class="line">tests			测试</span><br><span class="line">trie			以太坊重要的数据结构Package trie implements Merkle Patricia Tries.</span><br><span class="line">whisper			提供了whisper节点的协议。</span><br></pre></td></tr></table></figure>
<h3 id="1-5-以太坊关键概念"><a href="#1-5-以太坊关键概念" class="headerlink" title="1.5 以太坊关键概念"></a>1.5 以太坊关键概念</h3><p>####1.5.1 状态</p>
<p>以太坊中将状态转换的过程称为状态转换函数‘。</p>
<p>| 状态1  | 状态转换函数—&gt; | 状态2  |</p>
<p>以太坊的每一个区块头，都包含了指向三棵树的指针，分别是：状态树、交易树、收据树。</p>
<ul>
<li>交易树指针就类似于比特比区块头中的梅克尔树根，交易树是用来代表区块中发生的所有交易历史的；</li>
<li>状态树：代表访问区块后的整个状态；</li>
<li>收据树代表每笔交易对应的收据，守卫的收据是指每一笔交易影响的数据条，或者说是每一笔交易影响的结果。这些都是针对比特比中梅克尔交易树的增强，通过状态树可以很方便地获得类似账户存在与否、账户余额、订单状态这样的结果，而不用只依靠交易事务去追溯。</li>
</ul>
<p>以太坊状态树的示意图：</p>
<p><img src="http://p8azvgsnq.bkt.clouddn.com/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%8A%B6%E6%80%81%E6%A0%91.png" alt=""></p>
<p>如上图所示，状态树中存储了整个系统的状态数据，比如账户余额、合约存储、合约代码以及账户随机数等数据。状态树有点类似我们玩游戏时的存档功能。</p>
<p>再来看以下源码中如何定义状态树根哈希的：</p>
<p>go-ethereum/core/types/block.go: 以太坊的区块头结构</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Header <span class="keyword">struct</span> &#123;</span><br><span class="line">   ParentHash  common.Hash    <span class="string">`json:"parentHash"       gencodec:"required"`</span></span><br><span class="line">   UncleHash   common.Hash    <span class="string">`json:"sha3Uncles"       gencodec:"required"`</span></span><br><span class="line">   Coinbase    common.Address <span class="string">`json:"miner"            gencodec:"required"`</span></span><br><span class="line">   Root        common.Hash    <span class="string">`json:"stateRoot"        gencodec:"required"`</span></span><br><span class="line">   TxHash      common.Hash    <span class="string">`json:"transactionsRoot" gencodec:"required"`</span></span><br><span class="line">   ReceiptHash common.Hash    <span class="string">`json:"receiptsRoot"     gencodec:"required"`</span></span><br><span class="line">   Bloom       Bloom          <span class="string">`json:"logsBloom"        gencodec:"required"`</span></span><br><span class="line">   Difficulty  *big.Int       <span class="string">`json:"difficulty"       gencodec:"required"`</span></span><br><span class="line">   Number      *big.Int       <span class="string">`json:"number"           gencodec:"required"`</span></span><br><span class="line">   GasLimit    <span class="keyword">uint64</span>         <span class="string">`json:"gasLimit"         gencodec:"required"`</span></span><br><span class="line">   GasUsed     <span class="keyword">uint64</span>         <span class="string">`json:"gasUsed"          gencodec:"required"`</span></span><br><span class="line">   Time        *big.Int       <span class="string">`json:"timestamp"        gencodec:"required"`</span></span><br><span class="line">   Extra       []<span class="keyword">byte</span>         <span class="string">`json:"extraData"        gencodec:"required"`</span></span><br><span class="line">   MixDigest   common.Hash    <span class="string">`json:"mixHash"          gencodec:"required"`</span></span><br><span class="line">   Nonce       BlockNonce     <span class="string">`json:"nonce"            gencodec:"required"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>root : 状态树根哈希</li>
<li>TxHash：交易树根哈希</li>
<li>ReceiptHash：收据树根哈希</li>
</ul>
<p>####1.5.2 账户</p>
<p>在以太坊系统中，状态是由被称为“账户”的对象和在两个账户之间转移价值和信息的状态转换构成的，每个账户有一个20字节的地址，这个其实就跟银行账户差不多意思。 注意，比特币中是没有账户的概念的。</p>
<p>以太坊中由于有账户的概念，所以可直接获得当前的余额。</p>
<p>看以下代码中如何定义的：</p>
<p>go-ethereum/core/state/state_object.go中</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Account <span class="keyword">struct</span> &#123;</span><br><span class="line">   Nonce    <span class="keyword">uint64</span></span><br><span class="line">   Balance  *big.Int</span><br><span class="line">   Root     common.Hash <span class="comment">// merkle root of the storage trie</span></span><br><span class="line">   CodeHash []<span class="keyword">byte</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由代码可以看到，账户是由四个部分组成：</p>
<ul>
<li>Nonce：随机数，用于确定每笔交易只能被处理一次的计数器，实际上就是每个账户的交易计数，用以防止重放攻击，当一个账户发送一笔交易时，根据已经发送的交易数来累加这个数字，比如账户发送了5个交易，则账户随机数是5.</li>
<li>Balance：账户目前的以太币余额</li>
<li>Root：账户的存储（默认为空，指向的是一颗帕夏尔前缀树</li>
<li>CodeHash：账户的合约代码（只有合约账户才有，否则为空）</li>
</ul>
<p>以太坊中的账户是区分类型的：</p>
<p>1、外部账户</p>
<p>​    EOA，就是一般账户，外部所有账户是由一堆密钥定义的，一个私钥一个公钥，公钥的后20位作为其地址（跟比特比类似）。外部所有账户是没有代码的，但是可以通过创建和签名一笔交易从一个外部账户发送消息到合约账户，通过传递一些参数，如EOA的地址，合约的地址，以及数据，使用ABI作为传递数据的编码和解码的标准。</p>
<p>2、合约账户</p>
<p>​    合约账户是一种特殊的可编程账户，合约账户可以在账户间传递消息，合约存储在以太坊的区块链上，并被编译为以太坊虚拟字节码，合约账户也是有地址的，不过与外部所有账户不同，不是根据公钥来获得的，而是通过合约创建者的地址和该地址发出过的交易数量计算得到。</p>
<p>外部所有账户在以太坊中相当于一把钥匙，合约账户相当于一个籍贯，一旦被外部所有账户确认激活，机关就启动了。</p>
<h4 id="1-5-3-交易"><a href="#1-5-3-交易" class="headerlink" title="1.5.3 交易"></a>1.5.3 交易</h4><p>以太坊中的交易也就是上一节说到的状态转换过程。</p>
<p>在以太坊中交易是一个广义的概念，它的定义是指<strong>签名的数据包，这个数据包中存储了从外部账户发送的消息</strong>。</p>
<p>所谓的交易就是一个消息，这个消息被发送者签名了。</p>
<p>以太坊中的交易源码：</p>
<p>core/types/transaction.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Transaction <span class="keyword">struct</span> &#123;</span><br><span class="line">   data txdata</span><br><span class="line">   <span class="comment">// caches</span></span><br><span class="line">   hash atomic.Value</span><br><span class="line">   size atomic.Value</span><br><span class="line">   from atomic.Value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中的data是主要的字段，是结构体类型：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> txdata <span class="keyword">struct</span> &#123;</span><br><span class="line">   AccountNonce <span class="keyword">uint64</span>          <span class="string">`json:"nonce"    gencodec:"required"`</span></span><br><span class="line">   Price        *big.Int        <span class="string">`json:"gasPrice" gencodec:"required"`</span></span><br><span class="line">   GasLimit     <span class="keyword">uint64</span>          <span class="string">`json:"gas"      gencodec:"required"`</span></span><br><span class="line">   Recipient    *common.Address <span class="string">`json:"to"       rlp:"nil"`</span> <span class="comment">// nil means contract creation</span></span><br><span class="line">   Amount       *big.Int        <span class="string">`json:"value"    gencodec:"required"`</span></span><br><span class="line">   Payload      []<span class="keyword">byte</span>          <span class="string">`json:"input"    gencodec:"required"`</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// Signature values</span></span><br><span class="line">   V *big.Int <span class="string">`json:"v" gencodec:"required"`</span></span><br><span class="line">   R *big.Int <span class="string">`json:"r" gencodec:"required"`</span></span><br><span class="line">   S *big.Int <span class="string">`json:"s" gencodec:"required"`</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// This is only used when marshaling to JSON.</span></span><br><span class="line">   Hash *common.Hash <span class="string">`json:"hash" rlp:"-"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1）AccountNonce:表明交易发送者已发送过的交易数，与账户结构中定义的随机数对应；</p>
<p>2）Price与GasLimit：单价和所需的计算量，它俩的成绩是总的花费，用来抵抗DDOS攻击。</p>
<p>3）Recipient：接收方的地址</p>
<p>4）Amount：发送的以太币余额，单位是wei</p>
<p>5）Payload：交易携带的数据，根据不同的交易类型有不同的用法</p>
<p>6）V、R、S：交易的签名数据</p>
<p>上面没有发送方地址，是因为它可以通过签名获得。</p>
<p>以太坊中的3种交易类型：</p>
<p>1）转账交易</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web3.eth.sendTransaction(&#123;from:<span class="string">""</span>,to:<span class="string">""</span>,value:&#125;); <span class="comment">//web3.js是一个JS库，可以通过RPC调用与本地节点通信，实际上就是一个外部应用程序用来调用以太坊核心节点功能的一个调用库。</span></span><br></pre></td></tr></table></figure>
<p>2）合约创建交易</p>
<p>3）合约执行交易</p>
<p>交易数据在以太坊中是存在交易树中的，如1.5.1节中图所示，交易树非常类似BTC中的默克尔树，只不过存储的结构与编码方式有些差别。</p>
<h4 id="1-5-4-收据"><a href="#1-5-4-收据" class="headerlink" title="1.5.4 收据"></a>1.5.4 收据</h4><p>收据这个概念也是以太坊中特有的。</p>
<p>源码：</p>
<p>core/types/receipt.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Receipt <span class="keyword">struct</span> &#123;</span><br><span class="line">   <span class="comment">// Consensus fields</span></span><br><span class="line">   PostState         []<span class="keyword">byte</span> <span class="string">`json:"root"`</span></span><br><span class="line">   Status            <span class="keyword">uint64</span> <span class="string">`json:"status"`</span></span><br><span class="line">   CumulativeGasUsed <span class="keyword">uint64</span> <span class="string">`json:"cumulativeGasUsed" gencodec:"required"`</span></span><br><span class="line">   Bloom             Bloom  <span class="string">`json:"logsBloom"         gencodec:"required"`</span></span><br><span class="line">   Logs              []*Log <span class="string">`json:"logs"              gencodec:"required"`</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// Implementation fields (don't reorder!)</span></span><br><span class="line">   TxHash          common.Hash    <span class="string">`json:"transactionHash" gencodec:"required"`</span></span><br><span class="line">   ContractAddress common.Address <span class="string">`json:"contractAddress"`</span></span><br><span class="line">   GasUsed         <span class="keyword">uint64</span>         <span class="string">`json:"gasUsed" gencodec:"required"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>交易执行后会影响状态的变更，会消耗Gas，我们来看下上述结构体中的主要属性：</p>
<p>1）<code>PostState</code>：这是状态树的根哈希，不过不是直接存储的哈希值，而是转换为字节码存储，通过这个字段使得通过收据可以直接访问到状态数据。</p>
<p>2）<code>CumulativeGasUsed</code>：所在区块的gas交易之和</p>
<p>3）<code>TxHash</code>：交易事务的哈希值</p>
<p>4）<code>ContractAddress</code>：合约地址，如果是普通的转账交易则为空</p>
<p>5）<code>GasUsed</code>：本条交易消耗的Gas。</p>
<p>收据实际上是一个数据的统计记录，记录了交易执行后的特征数据。收据和交易是关联对应的。</p>
<p>其实从技术上来说收据不是必须的，没有它也可以查询到一些数据。它的存在只是为了提高账本数据在各种需求下的统计效率，方便各种查询。</p>
<h4 id="1-5-5-RLP编码"><a href="#1-5-5-RLP编码" class="headerlink" title="1.5.5 RLP编码"></a>1.5.5 RLP编码</h4><p>RLP（Recursive length prifix）,递归前缀编码，是一种数据编码方式，在以太坊中使用非常普遍，是以太坊中对象序列化的主要方式，在区块、交易、账户状态等地方都有使用。</p>
<p>比如交易从一个节点发送到另一个节点时，要被编译为一种特别的数据结构，这种结构称为trie树，也称为前缀树，然后根据这个前缀树计算出一个根哈希（上述的交易树，状态树，收据树都是这种方式），而这颗树的每一个数据项都会使用RLP的方式编码。</p>
<p>编码：将二进制数据按照某种格式和规则进行组装，以便于数据传送的编码与解码。</p>
<p><strong>RLP编码规则：</strong>略</p>
<p>1）单字节编码</p>
<p>2）字符串长度是0-55字节</p>
<p>3）字符串长度大于55字节</p>
<p>以上都是字符串的编码，以太坊中还涉及到列表的编码，网上文档很多，此处不赘述。</p>
<h4 id="1-5-6-默克尔-帕特里夏树"><a href="#1-5-6-默克尔-帕特里夏树" class="headerlink" title="1.5.6 默克尔-帕特里夏树"></a>1.5.6 默克尔-帕特里夏树</h4><p>我们都知道比特币中有默克尔树的概念，每个区块头都有默克尔根，实际上就是一个区块中交易哈希树的根哈希值，而以太坊的区块头中有三个根哈希（交易、状态、收据），对应各自的树结构。那么区别是什么呢？</p>
<p>严格来说，比特币中的默克尔树叫二叉默克尔树，而以太坊中是默克尔-帕特里夏树（<code>Merkle-Patricia Tree</code>,有时也称为帕特里夏树）,是一种更加复杂的结构，它是默克尔树和帕特里夏树的结合。</p>
<p>我们来了解下什么是帕特里夏树.</p>
<p>1）Patricia Tree</p>
<ul>
<li>应用场景：以交易数据为例，当交易数据从一个节点发送到另一个节点的时候，必须被编译为trie（前缀树），这个trie中的每一个项都使用RLP编码。在p2p网络上传输的交易是一个简单的列表，它们被组装成一个叫做trie树的特殊数据结构来计算根哈希，这意味着交易列表在本地以trie树的形式存储，发送给客户端的时候序列化成列表。这里的trie结构就是patiricia tree。</li>
<li>Ptricia Tree是基于trie tree的一种结构，trie tree是一种单词查找树结构。如下图：</li>
</ul>
<p><img src="http://p8azvgsnq.bkt.clouddn.com/trie%20tree.png" alt=""></p>
<p>trie中每个节点存储一个字符，这样能很好地节约存储空间。</p>
<p>而Ptiricia Tree每个节点可以存储字符串或者二进制串，这样就使其可以存储更为一般化的数据，而不只是一个单词字符：</p>
<p><img src="http://p8azvgsnq.bkt.clouddn.com/Patricia%20tree%E7%A4%BA%E6%84%8F%E5%9B%BE.png" alt=""></p>
<p>在这样的树结构中每个节点存储一个key-value键值对数据，key用来保存索引，是用来搜索定位的，value则是节点中具体的业务数据。 </p>
<p>而以太坊中的树结构在这个基础上还要复杂不少，我们来看看以太坊中的<code>Merkle Patricia Tree</code>具体是哪种结构。</p>
<p>2) 以太坊中用的<code>Merkle Patricia Tree</code></p>
<ul>
<li>首先以太坊中节点分为空节点、叶子节点、扩展节点、分支节点。树是由节点组成的，每个节点都是key-value形式，这些节点数据被存在本地的<code>LevelDB</code>中, <strong>以键值方式存储，value是节点的RLP编码，key则是RLP编码的哈希值。</strong></li>
</ul>
<hr>
<p>Node=（key,value） //节点中</p>
<hr>
<p>对应<code>LevelDB</code>中：</p>
<hr>
<p>value=RLP(Node)</p>
<p>key=sha3(value)</p>
<hr>
<p>以太坊网络中的核心客户端会不断地同步更新这个数据库以报错与网络中的其他客户端数据同步，源码中的定义：</p>
<p>trie/sync.go:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> SyncResult <span class="keyword">struct</span> &#123;</span><br><span class="line">   Hash common.Hash <span class="comment">// Hash of the originally unknown trie node</span></span><br><span class="line">   Data []<span class="keyword">byte</span>      <span class="comment">// Data content of the retrieved node</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>节点类型</li>
</ul>
<p>1）空节点：value中是一个空字符串</p>
<p>2）叶子节点：</p>
<p><img src="http://p8azvgsnq.bkt.clouddn.com/%E5%8F%B6%E5%AD%90%E8%8A%82%E7%82%B9.png" alt=""></p>
<p>3）扩展节点</p>
<p><img src="http://p8azvgsnq.bkt.clouddn.com/%E6%89%A9%E5%B1%95%E8%8A%82%E7%82%B9.png" alt=""></p>
<p>注意，扩展节点指向的是存储在<code>LevelDB</code>中的叶子节点哈希值。</p>
<p>4）分支节点</p>
<p>分支节点是真正存储业务数据的。<code>Merkle Partricia Tree</code>作为一种前缀树，主要特点是依靠共享的前缀来提高树结构的处理性能，那么这个前缀就很重要了，对于扩展节点的和叶子节点来说，节点key就是祈祷前缀的作用。</p>
<p><img src="http://p8azvgsnq.bkt.clouddn.com/%E5%88%86%E6%94%AF%E8%8A%82%E7%82%B9.png" alt=""></p>
<p>5）树结构示例</p>
<p>由于比特币只支持转账交易合约，所以默克尔树是一颗二叉哈希树，但以太坊支持智能合约，也增加了更多的概念，为了更有效的增删改查并且让树的结构更加平衡有效，因此设计除了更复杂的结构：</p>
<p><img src="http://p8azvgsnq.bkt.clouddn.com/%E9%BB%98%E5%85%8B%E5%B0%94-%E5%B8%95%E7%89%B9%E9%87%8C%E5%A4%8F%E6%A0%91.png" alt=""></p>
<ul>
<li>叶子节点1的前缀为01234，因为是由根节点01开始。就是要通过共享前缀来充分提高存取效率。</li>
<li>十六进制前缀<ul>
<li>由于分支节点的结构是长度为17的列表很容易判断，叶子节点和扩展节点都是长度为2的字节，是靠在key的前面增加4位二进制前缀来识别的。</li>
<li>最低位用来表示key长度的奇偶性，第二低位用来表示是否终止（1表示终止，也就是叶子节点，0表示扩展节点）</li>
</ul>
</li>
</ul>
<p><img src="http://p8azvgsnq.bkt.clouddn.com/%E5%A5%87%E5%81%B6%E6%80%A7%E5%89%8D%E7%BC%80.png" alt=""></p>
<p><img src="http://p8azvgsnq.bkt.clouddn.com/%E9%BB%98%E5%85%8B%E5%B0%94-%E5%B8%95%E7%89%B9%E9%87%8C%E5%A4%8F%E6%A0%912.png" alt=""></p>
<p><strong>注意</strong></p>
<p><strong>增加的16进制前缀并不是属于节点key的一部分，而仅仅是在构建树结构的时候附加上去的。整棵树表示的数据在网络中传递时候就是一个列表数据，而树结构是以太坊客户端接收到数据后另行构造出来的。</strong></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/以太坊源码解读/">以太坊源码解读</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/以太坊源码解读/">以太坊源码解读</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://yoursite.com/2018/05/29/以太坊源码解读【1】/" data-title="以太坊源码解读 | Bolen`s Blog" data-tsina="zliyong007" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2018/05/29/第1章-简介和配置/" title="GO基础【一】：介绍和安装">
  <strong>上一篇：</strong><br/>
  <span>
  GO基础【一】：介绍和安装</span>
</a>
</div>


<div class="next">
<a href="/2018/05/04/广度优先算法/"  title="">
 <strong>下一篇：</strong><br/> 
 <span>(no title)
</span>
</a>
</div>

</nav>

	



</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#go-ethereum源码解析"><span class="toc-text">go-ethereum源码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、以太坊概述"><span class="toc-text">1、以太坊概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-简介"><span class="toc-text">1.1 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-以太坊架构"><span class="toc-text">1.2 以太坊架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-以太坊常用项目介绍"><span class="toc-text">1.3 以太坊常用项目介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-以太坊目录简介"><span class="toc-text">1.4 以太坊目录简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-以太坊关键概念"><span class="toc-text">1.5 以太坊关键概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-3-交易"><span class="toc-text">1.5.3 交易</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-4-收据"><span class="toc-text">1.5.4 收据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-5-RLP编码"><span class="toc-text">1.5.5 RLP编码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-6-默克尔-帕特里夏树"><span class="toc-text">1.5.6 默克尔-帕特里夏树</span></a></li></ol></li></ol></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/MySQL笔记/" title="MySQL笔记">MySQL笔记<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/go基础/" title="go基础">go基础<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/others/" title="others">others<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/以太坊源码解读/" title="以太坊源码解读">以太坊源码解读<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/go基础/" title="go基础">go基础<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/MySQL基础/" title="MySQL基础">MySQL基础<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/method/" title="method">method<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/interface/" title="interface">interface<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Hexo/" title="Hexo">Hexo<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Blog/" title="Blog">Blog<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/以太坊源码解读/" title="以太坊源码解读">以太坊源码解读<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://liyuechun.org/" target="_blank" title="黎跃春">黎跃春</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.cnblogs.com/bolenzhang" target="_blank" title="My cnblog">My cnblog</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.ruanyifeng.com/blog" target="_blank" title="阮一峰">阮一峰</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="" target="_blank" title="rss">RSS</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">Weibo</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=zliyong007&verifier=a1405918&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 立德立言 无问西东 <br/>
			</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/zliyong007" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:zliyong007@163.com## e.g. imjark@gmail.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2018 
		
		<a href="/about" target="_blank" title="Bolen Zhang">Bolen Zhang</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>











<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
